<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Senac PR - Sescoop</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- SheetJS for Excel (.xlsx, .xls) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Cores do Senac */
        .bg-senac-blue { background-color: #004587; }
        .text-senac-blue { color: #004587; }
        .bg-senac-orange { background-color: #F68B1F; }
        .text-senac-orange { color: #F68B1F; }
        .border-senac-orange { border-color: #F68B1F; }

        /* Estilos de Impressão Otimizados */
        @media print {
            @page {
                margin: 1cm;
                size: A4; /* Define explicitamente tamanho A4 */
            }

            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 12px; /* Reduz levemente a fonte para caber mais */
            }

            /* Esconde elementos de navegação e filtros */
            .no-print { 
                display: none !important; 
            }

            .print-only { 
                display: block !important; 
            }

            /* Ajustes de Layout */
            #root {
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 0;
            }

            main {
                padding: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
            }

            /* Garante que o grid se mantenha ou se ajuste */
            .grid {
                display: grid !important;
                /* Em impressão, muitas vezes 2 colunas ficam apertadas em A4 retrato, 
                   mas vamos tentar manter ajustando o gap */
                gap: 1rem !important; 
            }

            /* Cards e Gráficos */
            .card { 
                box-shadow: none !important; 
                border: 1px solid #e5e7eb !important; /* Borda suave */
                break-inside: avoid !important; /* Evita quebrar o card no meio da página */
                page-break-inside: avoid !important;
                margin-bottom: 1rem;
            }

            /* Ajuste específico para os containers de gráfico */
            .chart-container-print {
                height: auto !important;
                min-height: 250px; /* Garante altura mínima mas flexível */
                page-break-inside: avoid;
            }

            /* Força largura total para evitar cortes */
            canvas {
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
            }

            /* Ajuste de Texto */
            h1, h2, h3 {
                color: #004587 !important; /* Garante cor do Senac na impressão */
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; color: #004587; font-weight: bold; flex-direction: column; gap: 10px;">
            <div>Carregando Sistema...</div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURAÇÃO DE SEGURANÇA ---
        const ACCESS_PASSWORD = "senac2026"; 

        // --- Dados Iniciais Mockados (ZERADOS) ---
        const INITIAL_DATA = [];

        // --- Função Auxiliar de Formatação de Data ---
        const formatDate = (dateString) => {
            if (!dateString) return "-";
            if (dateString instanceof Date) return dateString.toLocaleDateString('pt-BR');
            if (typeof dateString === 'string' && dateString.includes('/')) return dateString;
            try {
                if (typeof dateString === 'string' && dateString.includes('-')) {
                    const [year, month, day] = dateString.split('-');
                    if (day && month && year) return `${day}/${month}/${year}`;
                }
            } catch (e) { return dateString; }
            return dateString;
        };

        // --- Componentes UI ---

        const Card = ({ title, value, iconName, subtext, color = "blue" }) => (
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 card break-inside-avoid" style={{ borderColor: color === 'orange' ? '#F68B1F' : '#004587' }}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-gray-500 uppercase">{title}</p>
                        <h3 className="text-3xl font-bold mt-2 text-gray-800">{value}</h3>
                        {subtext && <p className="text-xs text-gray-400 mt-1">{subtext}</p>}
                    </div>
                    <div className={`p-3 rounded-full ${color === 'orange' ? 'bg-orange-100 text-senac-orange' : 'bg-blue-100 text-senac-blue'}`}>
                        <i data-lucide={iconName} className="w-6 h-6"></i>
                    </div>
                </div>
            </div>
        );

        const ChartContainer = ({ title, id }) => (
            <div className="bg-white p-6 rounded-xl shadow-sm card h-80 chart-container-print break-inside-avoid relative">
                <h3 className="text-lg font-semibold text-gray-700 mb-4">{title}</h3>
                <div className="relative h-64 w-full chart-canvas-wrapper">
                    <canvas id={id}></canvas>
                </div>
            </div>
        );

        // --- Componente de Login ---
        const LoginScreen = ({ onLogin }) => {
            const [password, setPassword] = useState("");
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === ACCESS_PASSWORD) {
                    onLogin();
                } else {
                    setError(true);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 px-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border-t-4 border-senac-blue">
                        <div className="text-center mb-8">
                             <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Senac PR" className="h-12 w-auto mx-auto mb-4" />
                             <h2 className="text-2xl font-bold text-senac-blue">Acesso Restrito</h2>
                             <p className="text-gray-500 text-sm mt-2">Dashboard de Aprendizagem SESCOOP/PR</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Senha de Acesso</label>
                                <input 
                                    type="password" 
                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                    placeholder="Digite a senha..."
                                    value={password}
                                    onChange={(e) => {setPassword(e.target.value); setError(false);}}
                                />
                            </div>
                            {error && <p className="text-red-500 text-sm">Senha incorreta. Tente novamente.</p>}
                            <button 
                                type="submit" 
                                className="w-full bg-senac-blue hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                            >
                                Entrar
                            </button>
                        </form>
                        <p className="text-center text-xs text-gray-400 mt-6">Sistema interno Senac PR</p>
                    </div>
                </div>
            );
        };

        // --- App Principal ---

        const App = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [data, setData] = useState(INITIAL_DATA);
            const [filteredData, setFilteredData] = useState(INITIAL_DATA);
            
            const [searchTerm, setSearchTerm] = useState("");
            const [statusFilter, setStatusFilter] = useState("Todos");
            const [projectFilter, setProjectFilter] = useState("Todos");
            const [cityFilter, setCityFilter] = useState("Todas");
            const [companyFilter, setCompanyFilter] = useState("Todas"); // Novo Estado para Empresa
            
            const chartRefs = useRef({});

            useEffect(() => {
                if (isAuthenticated && window.lucide) {
                    window.lucide.createIcons();
                }
            }, [filteredData, data, isAuthenticated]);

            const processImportedData = (rawData) => {
                const formattedData = rawData.map(row => {
                    const getVal = (key) => row[key] || row[key.trim()] || row[key + ' '] || '';
                    return {
                        projeto: getVal('Projeto'),
                        turma: getVal('Turma'),
                        situacao: getVal('Situação'),
                        inicio: getVal('Data de Inicio'),
                        fim: getVal('Data Fim'),
                        empresa: getVal('Empresa'),
                        cidade: getVal('Cidade'),
                        estado: getVal('Estado'),
                        nome: getVal('Nome do Aprendiz'),
                        matricula: getVal('Matricula'),
                        desligamento: getVal('Data Desligamento')
                    };
                });
                const cleanData = formattedData.filter(d => d.projeto && d.nome);
                setData(cleanData);
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: "" });
                        processImportedData(jsonData);
                    };
                    reader.readAsArrayBuffer(file);
                } 
                else if (fileName.endsWith('.csv')) {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        encoding: "UTF-8",
                        complete: (results) => {
                            processImportedData(results.data);
                        }
                    });
                } else {
                    alert("Formato de arquivo não suportado. Por favor use .xlsx, .xls ou .csv");
                }
            };

            // Lógica de Filtragem
            useEffect(() => {
                let temp = data;

                if (searchTerm) {
                    const lowerSearch = searchTerm.toLowerCase();
                    temp = temp.filter(item => 
                        (item.nome && item.nome.toLowerCase().includes(lowerSearch)) ||
                        (item.empresa && item.empresa.toLowerCase().includes(lowerSearch)) ||
                        (item.cidade && item.cidade.toLowerCase().includes(lowerSearch))
                    );
                }

                if (statusFilter !== "Todos") {
                    if (statusFilter === "Desligados") {
                         temp = temp.filter(d => (d.desligamento && d.desligamento.trim() !== "") || (d.matricula && d.matricula.toLowerCase().includes("desligado")));
                    } else if (statusFilter === "Ativos") {
                        temp = temp.filter(d => {
                            const isDesligado = (d.desligamento && d.desligamento.trim() !== "") || (d.matricula && d.matricula.toLowerCase().includes("desligado"));
                            const isFinalizado = d.situacao === 'Finalizada' || (d.matricula && d.matricula.includes("Finalizada"));
                            return !isDesligado && !isFinalizado;
                        });
                    } else if (statusFilter === "Finalizados") {
                        temp = temp.filter(d => d.situacao === 'Finalizada' || (d.matricula && d.matricula.includes("Finalizada")));
                    } else {
                        temp = temp.filter(item => item.situacao === statusFilter);
                    }
                }

                if (projectFilter !== "Todos") {
                    temp = temp.filter(item => item.projeto === projectFilter);
                }
                
                if (cityFilter !== "Todas") {
                    temp = temp.filter(item => item.cidade === cityFilter);
                }
                
                // Filtro de Empresa
                if (companyFilter !== "Todas") {
                    temp = temp.filter(item => item.empresa === companyFilter);
                }

                setFilteredData(temp);
            }, [data, searchTerm, statusFilter, projectFilter, cityFilter, companyFilter]);

            const stats = useMemo(() => {
                const total = filteredData.length;
                const ativos = filteredData.filter(d => {
                    const isDesligado = (d.desligamento && d.desligamento.trim() !== "") || (d.matricula && d.matricula.toLowerCase().includes("desligado"));
                    const isFinalizado = d.situacao === 'Finalizada' || (d.matricula && d.matricula.includes("Finalizada"));
                    return !isDesligado && !isFinalizado;
                }).length;

                const desligados = filteredData.filter(d => 
                    (d.desligamento && d.desligamento.trim() !== "") || 
                    (d.matricula && d.matricula.toLowerCase().includes("desligado"))
                ).length;
                
                const finalizados = filteredData.filter(d => d.situacao === 'Finalizada' || (d.matricula && d.matricula.includes("Finalizada"))).length;

                return { total, ativos, desligados, finalizados };
            }, [filteredData]);

            const uniqueProjects = useMemo(() => [...new Set(data.map(item => item.projeto))].filter(Boolean).sort(), [data]);
            const uniqueCities = useMemo(() => [...new Set(data.map(item => item.cidade))].filter(Boolean).sort(), [data]);
            const uniqueCompanies = useMemo(() => [...new Set(data.map(item => item.empresa))].filter(Boolean).sort(), [data]); // Lista única de empresas

            // Atualização dos Gráficos
            useEffect(() => {
                if (typeof Chart === 'undefined' || !isAuthenticated) return;

                const desligadosData = filteredData.filter(d => (d.desligamento && d.desligamento.trim() !== "") || (d.matricula && d.matricula.toLowerCase().includes("desligado")));
                
                const byCityDesligados = {};
                desligadosData.forEach(d => {
                    const city = d.cidade || "Não Informado";
                    byCityDesligados[city] = (byCityDesligados[city] || 0) + 1;
                });

                // Lógica de Datas
                const byPeriodDesligados = {};
                desligadosData.forEach(d => {
                    let dateKey = "";
                    let sortKey = "";
                    
                    if (d.desligamento) {
                        try {
                            let dateObj = null;
                            if (d.desligamento.includes('-')) { 
                                const parts = d.desligamento.split('-');
                                dateObj = new Date(parts[0], parts[1]-1, 1);
                            } else if (d.desligamento.includes('/')) { 
                                const parts = d.desligamento.split('/');
                                if (parts.length === 3) dateObj = new Date(parts[2], parts[1]-1, 1);
                            }

                            if (dateObj && !isNaN(dateObj)) {
                                const monthName = dateObj.toLocaleString('pt-BR', { month: 'short' });
                                const year = dateObj.getFullYear();
                                sortKey = `${year}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
                                dateKey = `${monthName}/${year}`;
                                if (!byPeriodDesligados[sortKey]) {
                                    byPeriodDesligados[sortKey] = { label: dateKey, count: 0 };
                                }
                                byPeriodDesligados[sortKey].count += 1;
                            }
                        } catch (e) { console.error("Erro data", e) }
                    }
                });

                const sortedKeys = Object.keys(byPeriodDesligados).sort();
                const periodLabels = sortedKeys.map(k => byPeriodDesligados[k].label);
                const periodValues = sortedKeys.map(k => byPeriodDesligados[k].count);

                const byEmpresaDesligados = {};
                desligadosData.forEach(d => {
                    const emp = d.empresa || "Não Informado";
                    byEmpresaDesligados[emp] = (byEmpresaDesligados[emp] || 0) + 1;
                });
                const topEmpresasDeslLabels = Object.keys(byEmpresaDesligados).sort((a,b) => byEmpresaDesligados[b] - byEmpresaDesligados[a]).slice(0, 10);
                const topEmpresasDeslValues = topEmpresasDeslLabels.map(l => byEmpresaDesligados[l]);

                const ativosData = filteredData.filter(d => {
                    const isDesligado = (d.desligamento && d.desligamento.trim() !== "") || (d.matricula && d.matricula.toLowerCase().includes("desligado"));
                    const isFinalizado = d.situacao === 'Finalizada' || (d.matricula && d.matricula.includes("Finalizada"));
                    return !isDesligado && !isFinalizado;
                });
                
                const byCityAtivos = {};
                ativosData.forEach(d => {
                    const city = d.cidade || "Não Informado";
                    byCityAtivos[city] = (byCityAtivos[city] || 0) + 1;
                });

                const byEmpresaAtivos = {};
                ativosData.forEach(d => {
                    const emp = d.empresa || "Não Informado";
                    byEmpresaAtivos[emp] = (byEmpresaAtivos[emp] || 0) + 1;
                });
                const topEmpresasLabels = Object.keys(byEmpresaAtivos).sort((a,b) => byEmpresaAtivos[b] - byEmpresaAtivos[a]).slice(0, 5);
                const topEmpresasValues = topEmpresasLabels.map(l => byEmpresaAtivos[l]);

                const statusCounts = {
                    'Ativos': stats.ativos,
                    'Desligados': stats.desligados,
                    'Finalizados': stats.finalizados
                };

                const limitChartData = (objData) => {
                    if (cityFilter !== "Todas" || companyFilter !== "Todas") return { labels: Object.keys(objData), values: Object.values(objData) };
                    const sortedKeys = Object.keys(objData).sort((a,b) => objData[b] - objData[a]);
                    const topKeys = sortedKeys.slice(0, 15);
                    return { labels: topKeys, values: topKeys.map(k => objData[k]) };
                };

                const cityAtivosClean = limitChartData(byCityAtivos);
                const cityDesligadosClean = limitChartData(byCityDesligados);

                const destroyChart = (id) => {
                    if (chartRefs.current[id]) {
                        chartRefs.current[id].destroy();
                        chartRefs.current[id] = null;
                    }
                };

                const ctxs = {
                    ativos: document.getElementById('chartAtivos'),
                    desligados: document.getElementById('chartDesligados'),
                    empresas: document.getElementById('chartEmpresas'),
                    status: document.getElementById('chartStatus'),
                    evolucao: document.getElementById('chartEvolucao'),
                    empresaDesl: document.getElementById('chartEmpresaDesl')
                };

                const integerAxisOptions = {
                    y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
                };

                destroyChart('ativos');
                if (ctxs.ativos) {
                    chartRefs.current['ativos'] = new Chart(ctxs.ativos, {
                        type: 'bar',
                        data: {
                            labels: cityAtivosClean.labels,
                            datasets: [{ label: 'Ativos', data: cityAtivosClean.values, backgroundColor: '#004587', borderRadius: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: integerAxisOptions, plugins: { legend: { display: false } } }
                    });
                }

                destroyChart('desligados');
                if (ctxs.desligados) {
                    chartRefs.current['desligados'] = new Chart(ctxs.desligados, {
                        type: 'bar',
                        data: {
                            labels: cityDesligadosClean.labels,
                            datasets: [{ label: 'Desligamentos', data: cityDesligadosClean.values, backgroundColor: '#EF4444', borderRadius: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: integerAxisOptions, plugins: { legend: { display: false } } }
                    });
                }

                destroyChart('empresas');
                if (ctxs.empresas) {
                    chartRefs.current['empresas'] = new Chart(ctxs.empresas, {
                        type: 'bar',
                        data: {
                            labels: topEmpresasLabels,
                            datasets: [{ label: 'Ativos', data: topEmpresasValues, backgroundColor: '#3B82F6', borderRadius: 4 }]
                        },
                        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                    });
                }

                destroyChart('status');
                if (ctxs.status) {
                    chartRefs.current['status'] = new Chart(ctxs.status, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(statusCounts),
                            datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#004587', '#EF4444', '#10B981'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }

                destroyChart('evolucao');
                if (ctxs.evolucao) {
                    chartRefs.current['evolucao'] = new Chart(ctxs.evolucao, {
                        type: 'bar',
                        data: {
                            labels: periodLabels,
                            datasets: [{ 
                                label: 'Desligamentos no Mês', 
                                data: periodValues, 
                                backgroundColor: '#F68B1F',
                                borderRadius: 4
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1, precision: 0 },
                                    title: { display: true, text: 'Qtd. de Pessoas Desligadas' }
                                },
                                x: {
                                    title: { display: true, text: 'Período (Mês/Ano)' }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: { label: function(context) { return ` ${context.parsed.y} pessoas desligadas`; } }
                                }
                            }
                        }
                    });
                }

                destroyChart('empresaDesl');
                if (ctxs.empresaDesl) {
                    chartRefs.current['empresaDesl'] = new Chart(ctxs.empresaDesl, {
                        type: 'bar',
                        data: {
                            labels: topEmpresasDeslLabels,
                            datasets: [{ label: 'Desligamentos', data: topEmpresasDeslValues, backgroundColor: '#EF4444', borderRadius: 4 }]
                        },
                        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
                    });
                }

                return () => {
                    Object.keys(chartRefs.current).forEach(key => {
                        if(chartRefs.current[key]) chartRefs.current[key].destroy();
                    });
                };

            }, [filteredData, stats, cityFilter, companyFilter, isAuthenticated]);

            const handlePrint = () => {
                window.print();
            };

            if (!isAuthenticated) {
                return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;
            }

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Senac PR" className="h-10 w-auto" onError={(e) => {e.target.style.display='none'; e.target.nextSibling.style.display='block'}} />
                                <div style={{display: 'none'}} className="text-senac-blue font-bold text-2xl">SENAC</div>
                                <div className="border-l pl-4 border-gray-300">
                                    <h1 className="text-xl font-bold text-senac-blue">Dashboard de Aprendizagem</h1>
                                    <p className="text-xs text-gray-500">Relatório Analítico - SESCOOP/PR</p>
                                </div>
                            </div>
                            <div className="flex gap-2 no-print">
                                <label className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg cursor-pointer transition text-sm text-gray-700 font-medium">
                                    <i data-lucide="upload-cloud" className="w-4 h-4"></i>
                                    Carregar Arquivo (Excel/CSV)
                                    <input type="file" accept=".csv, .xlsx, .xls" onChange={handleFileUpload} className="hidden" />
                                </label>
                                <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 bg-senac-blue hover:bg-blue-800 text-white rounded-lg transition text-sm font-medium shadow-md">
                                    <i data-lucide="printer" className="w-4 h-4"></i>
                                    Imprimir Relatório
                                </button>
                                <button onClick={() => setIsAuthenticated(false)} className="flex items-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition text-sm font-medium">
                                    <i data-lucide="log-out" className="w-4 h-4"></i>
                                    Sair
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        
                        {/* Filters Bar - Atualizado com Grid para 5 colunas */}
                        <div className="bg-white p-4 rounded-xl shadow-sm mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end no-print border border-gray-100">
                            
                            {/* Filtro Cidade */}
                            <div className="w-full">
                                <label className="block text-xs font-semibold text-gray-500 mb-1 uppercase">Cidade</label>
                                <select 
                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"
                                    value={cityFilter}
                                    onChange={(e) => setCityFilter(e.target.value)}
                                >
                                    <option value="Todas">Todas as Cidades</option>
                                    {uniqueCities.map(city => <option key={city} value={city}>{city}</option>)}
                                </select>
                            </div>

                            {/* Filtro Empresa - NOVO */}
                            <div className="w-full">
                                <label className="block text-xs font-semibold text-gray-500 mb-1 uppercase">Empresa</label>
                                <select 
                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"
                                    value={companyFilter}
                                    onChange={(e) => setCompanyFilter(e.target.value)}
                                >
                                    <option value="Todas">Todas as Empresas</option>
                                    {uniqueCompanies.map(emp => <option key={emp} value={emp}>{emp}</option>)}
                                </select>
                            </div>

                            {/* Filtro Projeto */}
                            <div className="w-full">
                                <label className="block text-xs font-semibold text-gray-500 mb-1 uppercase">Projeto</label>
                                <select 
                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"
                                    value={projectFilter}
                                    onChange={(e) => setProjectFilter(e.target.value)}
                                >
                                    <option value="Todos">Todos os Projetos</option>
                                    {uniqueProjects.map(proj => <option key={proj} value={proj}>{proj}</option>)}
                                </select>
                            </div>

                            {/* Filtro Situação */}
                            <div className="w-full">
                                <label className="block text-xs font-semibold text-gray-500 mb-1 uppercase">Situação</label>
                                <select 
                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"
                                    value={statusFilter}
                                    onChange={(e) => setStatusFilter(e.target.value)}
                                >
                                    <option value="Todos">Todas</option>
                                    <option value="Ativos">Somente Ativos</option>
                                    <option value="Desligados">Somente Desligados</option>
                                    <option value="Finalizados">Somente Finalizados</option>
                                </select>
                            </div>
                            
                            {/* Busca */}
                            <div className="w-full">
                                <label className="block text-xs font-semibold text-gray-500 mb-1 uppercase">Buscar</label>
                                <div className="relative">
                                    <i data-lucide="search" className="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                    <input 
                                        type="text" 
                                        placeholder="Nome, empresa..." 
                                        className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <Card 
                                title="Total Aprendizes" 
                                value={stats.total} 
                                iconName="users" 
                                color="blue"
                            />
                            <Card 
                                title="Aprendizes Ativos" 
                                value={stats.ativos} 
                                iconName="user-check" 
                                color="blue"
                            />
                            <Card 
                                title="Desligados" 
                                value={stats.desligados} 
                                iconName="user-x" 
                                subtext="Contratos encerrados antecipadamente"
                                color="orange"
                            />
                             <Card 
                                title="Finalizados" 
                                value={stats.finalizados} 
                                iconName="graduation-cap" 
                                color="blue"
                            />
                        </div>

                        {/* Charts Section - Cidades */}
                        <div className="mb-4 break-inside-avoid">
                            <h2 className="text-lg font-bold text-gray-700 mb-2 border-l-4 border-senac-blue pl-2">Análise por Localidade</h2>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 break-inside-avoid">
                            <ChartContainer title="Ativos por Cidade (Top 15 ou Seleção)" id="chartAtivos" />
                            <ChartContainer title="Desligamentos por Cidade (Top 15 ou Seleção)" id="chartDesligados" />
                        </div>

                        {/* Charts Section - Análise de Desligamentos */}
                        <div className="mb-4 mt-8 break-inside-avoid">
                            <h2 className="text-lg font-bold text-gray-700 mb-2 border-l-4 border-senac-orange pl-2">Análise de Desligamentos</h2>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 break-inside-avoid">
                            <ChartContainer title="Evolução de Desligamentos (Por Mês)" id="chartEvolucao" />
                            <ChartContainer title="Top Empresas com Desligamentos" id="chartEmpresaDesl" />
                        </div>

                        {/* Charts Section - Geral */}
                         <div className="mb-4 mt-8 break-inside-avoid">
                            <h2 className="text-lg font-bold text-gray-700 mb-2 border-l-4 border-gray-400 pl-2">Panorama Geral</h2>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 break-inside-avoid">
                            <ChartContainer title="Top 5 Empresas com mais Ativos" id="chartEmpresas" />
                            <ChartContainer title="Status Geral dos Contratos" id="chartStatus" />
                        </div>

                        {/* Data Table */}
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mt-8 break-inside-avoid">
                            <div className="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                <h3 className="font-semibold text-gray-700">Detalhamento dos Dados</h3>
                                <span className="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full">{filteredData.length} Registros</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3">Projeto</th>
                                            <th className="px-6 py-3">Aprendiz</th>
                                            <th className="px-6 py-3">Empresa / Cidade</th>
                                            <th className="px-6 py-3">Situação</th>
                                            <th className="px-6 py-3">Desligamento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredData.length > 0 ? (
                                            filteredData.map((item, index) => {
                                                const isDesligado = (item.desligamento && item.desligamento !== "") || (item.matricula && item.matricula.includes("Desligado"));
                                                return (
                                                    <tr key={index} className="bg-white border-b hover:bg-gray-50">
                                                        <td className="px-6 py-4 font-medium text-gray-900">{item.projeto}</td>
                                                        <td className="px-6 py-4">
                                                            <div className="font-medium text-senac-blue">{item.nome}</div>
                                                            <div className="text-xs text-gray-400">Turma: {item.turma}</div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="text-gray-900">{item.empresa}</div>
                                                            <div className="text-xs text-gray-500">{item.cidade} - {item.estado}</div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <span className={`px-2 py-1 rounded-full text-xs font-semibold
                                                                ${isDesligado ? 'bg-red-100 text-red-600' : 
                                                                  item.situacao === 'Finalizada' ? 'bg-green-100 text-green-600' : 
                                                                  'bg-blue-100 text-blue-600'}`}>
                                                                {isDesligado ? "Desligado" : item.situacao}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 text-gray-500">
                                                            {formatDate(item.desligamento)}
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        ) : (
                                            <tr>
                                                <td colSpan="5" className="px-6 py-10 text-center text-gray-500">
                                                    {data.length === 0 
                                                        ? "Nenhum dado carregado. Utilize o botão 'Carregar Arquivo' acima." 
                                                        : "Nenhum dado encontrado para os filtros selecionados."}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <footer className="mt-10 text-center text-xs text-gray-400 print-only">
                            <p>Relatório gerado em {new Date().toLocaleDateString()} via Dashboard Senac PR</p>
                        </footer>

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
    </script>
</body>
</html>
